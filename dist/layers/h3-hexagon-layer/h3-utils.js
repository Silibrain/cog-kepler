'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.h3GetResolution = undefined;

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

exports.getVertices = getVertices;
exports.getCentroid = getCentroid;
exports.idToPolygonGeo = idToPolygonGeo;
exports.getCenterHex = getCenterHex;
exports.getH3VerticeTransform = getH3VerticeTransform;
exports.transformCylinderPositions = transformCylinderPositions;
exports.getRadius = getRadius;
exports.getAngle = getAngle;

var _h3Js = require('h3-js');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.h3GetResolution = _h3Js.h3GetResolution;

// get vertices should return [lon, lat]
// Copyright (c) 2018 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

function getVertices(_ref) {
  var id = _ref.id;

  // always reverse it
  return (0, _h3Js.h3ToGeoBoundary)(id, true);
}

// get centroid should return [lon, lat]
function getCentroid(_ref2) {
  var id = _ref2.id;

  // always reverse it to [lng, lat]
  return (0, _h3Js.h3ToGeo)(id).reverse();
}

function idToPolygonGeo(_ref3, properties) {
  var object = _ref3.object;

  if (!object || !object.id) {
    return null;
  }

  var vertices = getVertices(object);

  return {
    geometry: {
      coordinates: vertices,
      type: 'LineString'
    },
    properties: properties
  };
}

function getCenterHex(_ref4, resolution) {
  var latitude = _ref4.latitude,
      longitude = _ref4.longitude;

  return (0, _h3Js.geoToH3)(latitude, longitude, resolution);
}

// H3 hexagon are not perfect hexagon after projection, they are slightly distorted
// Here we calculate the translation from perfect hexagon to h3 hexagon
// A mathematica proof can be found at
// https://beta.observablehq.com/@heshan0131/h3-hexagon-shape-normalize
function getH3VerticeTransform(rawVertices, centroid) {
  var vertices = revertVertices(rawVertices.map(function (vt) {
    return offset(vt, centroid);
  }));
  var radius = getRadius(vertices[0], vertices[3]);

  var angle = getAngle(vertices[0], vertices[3]);

  // rotate hexagon vertices, so that v0 - v3 axis parallel with xAxis
  //   2___1
  // 3 /   \ 0
  //   \___/
  //   4   5
  //
  var rotatedVertices = vertices.map(function (vt) {
    return rotate([0, 0], vt, angle);
  });

  // vertices of a perfect hexagon
  var normalVertices = getHexagonVertices(radius);

  // calculate translation
  return getTranslations(rotatedVertices, normalVertices);
}

// Vertices index based on
// https://github.com/uber/luma.gl/blob/master/modules/core/src/geometry/truncated-cone-geometry.js
function transformCylinderPositions(positions, translations) {

  var primitives = translations.map(function (_ref5, i) {
    var dr = _ref5.dr,
        da = _ref5.da;
    return getPtOnCircle(dr, da + Math.PI * i / 3);
  });
  // close it
  primitives.push(primitives[0]);

  // starting from the 8th vertice, repeat 4 times, only replace x(0), y(1)
  return positions.map(function (v, i) {
    if (i > 20 && i < 21 * 5 && i % 3 < 2) {
      var row = Math.floor(i / 3);
      var col = i % 3;
      return primitives[row % 7][col];
    }
    return v;
  });
}

function offset(_ref6, _ref7) {
  var _ref9 = (0, _slicedToArray3.default)(_ref6, 2),
      px = _ref9[0],
      py = _ref9[1];

  var _ref8 = (0, _slicedToArray3.default)(_ref7, 2),
      x0 = _ref8[0],
      y0 = _ref8[1];

  return [[px - x0], [py - y0]];
}

function rotate(_ref10, _ref11, radians) {
  var _ref13 = (0, _slicedToArray3.default)(_ref10, 2),
      cx = _ref13[0],
      cy = _ref13[1];

  var _ref12 = (0, _slicedToArray3.default)(_ref11, 2),
      x = _ref12[0],
      y = _ref12[1];

  var cos = Math.cos(radians);
  var sin = Math.sin(radians);
  var nx = cos * (x - cx) + sin * (y - cy) + cx;
  var ny = cos * (y - cy) - sin * (x - cx) + cy;

  return [nx, ny];
}

function getDistance(pt0, pt1) {
  var dx = pt0[0] - pt1[0];
  var dy = pt0[1] - pt1[1];
  var dxy = Math.sqrt(dx * dx + dy * dy);
  return dxy;
}

function getRadius(pt0, pt3) {
  var dxy = getDistance(pt0, pt3);
  return dxy / 2;
}

function getAngle(pt0, pt3) {
  var dx = pt0[0] - pt3[0];
  var dy = pt0[1] - pt3[1];
  var dxy = Math.sqrt(dx * dx + dy * dy);

  // Calculate angle that the perpendicular hexagon vertex axis is tilted
  var angle = Math.acos(dx / dxy) * Math.sign(dy);
  return angle;
}

function getPtOnCircle(radius, angle) {
  return [radius * Math.cos(angle), radius * Math.sin(angle)];
}

function getHexagonVertices(r) {
  var ang60 = Math.PI / 3;
  var pts = [];
  for (var i = 0; i < 6; i++) {
    pts.push(getPtOnCircle(r, ang60 * i));
  }

  return pts;
}

function revertVertices(verts) {
  // reverting verts from clock (h3) to counter clock wise (luma cylinder)
  var seq = [0, 5, 4, 3, 2, 1];
  return seq.map(function (s) {
    return verts[s];
  });
}

function getTranslations(vts, origs) {
  // 0 and 3 should be the guide
  var ct = [0, 0];
  var translations = [];

  for (var i = 0; i < 6; i++) {
    var vt = vts[i];
    var org = origs[i];

    var r = getRadius(org, ct);
    var dr = getRadius(vt, ct) / r;

    var da = Math.atan2(vt[1], vt[0]) - Math.atan2(org[1], org[0]);

    translations.push({ dr: dr, da: da });
  }

  return translations;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvaDMtaGV4YWdvbi1sYXllci9oMy11dGlscy5qcyJdLCJuYW1lcyI6WyJnZXRWZXJ0aWNlcyIsImdldENlbnRyb2lkIiwiaWRUb1BvbHlnb25HZW8iLCJnZXRDZW50ZXJIZXgiLCJnZXRIM1ZlcnRpY2VUcmFuc2Zvcm0iLCJ0cmFuc2Zvcm1DeWxpbmRlclBvc2l0aW9ucyIsImdldFJhZGl1cyIsImdldEFuZ2xlIiwiaDNHZXRSZXNvbHV0aW9uIiwiaWQiLCJyZXZlcnNlIiwicHJvcGVydGllcyIsIm9iamVjdCIsInZlcnRpY2VzIiwiZ2VvbWV0cnkiLCJjb29yZGluYXRlcyIsInR5cGUiLCJyZXNvbHV0aW9uIiwibGF0aXR1ZGUiLCJsb25naXR1ZGUiLCJyYXdWZXJ0aWNlcyIsImNlbnRyb2lkIiwicmV2ZXJ0VmVydGljZXMiLCJtYXAiLCJvZmZzZXQiLCJ2dCIsInJhZGl1cyIsImFuZ2xlIiwicm90YXRlZFZlcnRpY2VzIiwicm90YXRlIiwibm9ybWFsVmVydGljZXMiLCJnZXRIZXhhZ29uVmVydGljZXMiLCJnZXRUcmFuc2xhdGlvbnMiLCJwb3NpdGlvbnMiLCJ0cmFuc2xhdGlvbnMiLCJwcmltaXRpdmVzIiwiaSIsImRyIiwiZGEiLCJnZXRQdE9uQ2lyY2xlIiwiTWF0aCIsIlBJIiwicHVzaCIsInYiLCJyb3ciLCJmbG9vciIsImNvbCIsInB4IiwicHkiLCJ4MCIsInkwIiwicmFkaWFucyIsImN4IiwiY3kiLCJ4IiwieSIsImNvcyIsInNpbiIsIm54IiwibnkiLCJnZXREaXN0YW5jZSIsInB0MCIsInB0MSIsImR4IiwiZHkiLCJkeHkiLCJzcXJ0IiwicHQzIiwiYWNvcyIsInNpZ24iLCJyIiwiYW5nNjAiLCJwdHMiLCJ2ZXJ0cyIsInNlcSIsInMiLCJ2dHMiLCJvcmlncyIsImN0Iiwib3JnIiwiYXRhbjIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O1FBd0JnQkEsVyxHQUFBQSxXO1FBTUFDLFcsR0FBQUEsVztRQUtB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QVA7QUFDRCIsImZpbGUiOiJoMy11dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAxOCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7aDNHZXRSZXNvbHV0aW9uLCBoM1RvR2VvLCBoM1RvR2VvQm91bmRhcnksIGdlb1RvSDN9IGZyb20gJ2gzLWpzJztcbmV4cG9ydCB7aDNHZXRSZXNvbHV0aW9ufTtcblxuLy8gZ2V0IHZlcnRpY2VzIHNob3VsZCByZXR1cm4gW2xvbiwgbGF0XVxuZXhwb3J0IGZ1bmN0aW9uIGdldFZlcnRpY2VzKHtpZH0pIHtcbiAgLy8gYWx3YXlzIHJldmVyc2UgaXRcbiAgcmV0dXJuIGgzVG9HZW9Cb3VuZGFyeShpZCwgdHJ1ZSk7XG59XG5cbi8vIGdldCBjZW50cm9pZCBzaG91bGQgcmV0dXJuIFtsb24sIGxhdF1cbmV4cG9ydCBmdW5jdGlvbiBnZXRDZW50cm9pZCh7aWR9KSB7XG4gIC8vIGFsd2F5cyByZXZlcnNlIGl0IHRvIFtsbmcsIGxhdF1cbiAgcmV0dXJuIGgzVG9HZW8oaWQpLnJldmVyc2UoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlkVG9Qb2x5Z29uR2VvKHtvYmplY3R9LCBwcm9wZXJ0aWVzKSB7XG4gIGlmICghb2JqZWN0IHx8ICFvYmplY3QuaWQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHZlcnRpY2VzID0gZ2V0VmVydGljZXMob2JqZWN0KTtcblxuICByZXR1cm4ge1xuICAgIGdlb21ldHJ5OiB7XG4gICAgICBjb29yZGluYXRlczogdmVydGljZXMsXG4gICAgICB0eXBlOiAnTGluZVN0cmluZydcbiAgICB9LFxuICAgIHByb3BlcnRpZXNcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENlbnRlckhleCh7bGF0aXR1ZGUsIGxvbmdpdHVkZX0sIHJlc29sdXRpb24pIHtcbiAgcmV0dXJuIGdlb1RvSDMobGF0aXR1ZGUsIGxvbmdpdHVkZSwgcmVzb2x1dGlvbik7XG59XG5cbi8vIEgzIGhleGFnb24gYXJlIG5vdCBwZXJmZWN0IGhleGFnb24gYWZ0ZXIgcHJvamVjdGlvbiwgdGhleSBhcmUgc2xpZ2h0bHkgZGlzdG9ydGVkXG4vLyBIZXJlIHdlIGNhbGN1bGF0ZSB0aGUgdHJhbnNsYXRpb24gZnJvbSBwZXJmZWN0IGhleGFnb24gdG8gaDMgaGV4YWdvblxuLy8gQSBtYXRoZW1hdGljYSBwcm9vZiBjYW4gYmUgZm91bmQgYXRcbi8vIGh0dHBzOi8vYmV0YS5vYnNlcnZhYmxlaHEuY29tL0BoZXNoYW4wMTMxL2gzLWhleGFnb24tc2hhcGUtbm9ybWFsaXplXG5leHBvcnQgZnVuY3Rpb24gZ2V0SDNWZXJ0aWNlVHJhbnNmb3JtKHJhd1ZlcnRpY2VzLCBjZW50cm9pZCkge1xuICBjb25zdCB2ZXJ0aWNlcyA9IHJldmVydFZlcnRpY2VzKHJhd1ZlcnRpY2VzLm1hcCh2dCA9PiBvZmZzZXQodnQsIGNlbnRyb2lkKSkpO1xuICBjb25zdCByYWRpdXMgPSBnZXRSYWRpdXModmVydGljZXNbMF0sIHZlcnRpY2VzWzNdKTtcblxuICBjb25zdCBhbmdsZSA9IGdldEFuZ2xlKHZlcnRpY2VzWzBdLCB2ZXJ0aWNlc1szXSlcblxuICAvLyByb3RhdGUgaGV4YWdvbiB2ZXJ0aWNlcywgc28gdGhhdCB2MCAtIHYzIGF4aXMgcGFyYWxsZWwgd2l0aCB4QXhpc1xuICAvLyAgIDJfX18xXG4gIC8vIDMgLyAgIFxcIDBcbiAgLy8gICBcXF9fXy9cbiAgLy8gICA0ICAgNVxuICAvL1xuICBjb25zdCByb3RhdGVkVmVydGljZXMgPSB2ZXJ0aWNlcy5tYXAodnQgPT4gcm90YXRlKFswLCAwXSwgdnQsIGFuZ2xlKSk7XG5cbiAgLy8gdmVydGljZXMgb2YgYSBwZXJmZWN0IGhleGFnb25cbiAgY29uc3Qgbm9ybWFsVmVydGljZXMgPSBnZXRIZXhhZ29uVmVydGljZXMocmFkaXVzKTtcblxuICAvLyBjYWxjdWxhdGUgdHJhbnNsYXRpb25cbiAgcmV0dXJuIGdldFRyYW5zbGF0aW9ucyhyb3RhdGVkVmVydGljZXMsIG5vcm1hbFZlcnRpY2VzKVxufVxuXG4vLyBWZXJ0aWNlcyBpbmRleCBiYXNlZCBvblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL3ViZXIvbHVtYS5nbC9ibG9iL21hc3Rlci9tb2R1bGVzL2NvcmUvc3JjL2dlb21ldHJ5L3RydW5jYXRlZC1jb25lLWdlb21ldHJ5LmpzXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNmb3JtQ3lsaW5kZXJQb3NpdGlvbnMocG9zaXRpb25zLCB0cmFuc2xhdGlvbnMpIHtcblxuICBjb25zdCBwcmltaXRpdmVzID0gdHJhbnNsYXRpb25zLm1hcCgoe2RyLCBkYX0sIGkpID0+XG4gICAgZ2V0UHRPbkNpcmNsZShkciwgZGEgKyBNYXRoLlBJICogaSAvIDMpKTtcbiAgLy8gY2xvc2UgaXRcbiAgcHJpbWl0aXZlcy5wdXNoKHByaW1pdGl2ZXNbMF0pO1xuXG4gIC8vIHN0YXJ0aW5nIGZyb20gdGhlIDh0aCB2ZXJ0aWNlLCByZXBlYXQgNCB0aW1lcywgb25seSByZXBsYWNlIHgoMCksIHkoMSlcbiAgcmV0dXJuIHBvc2l0aW9ucy5tYXAoKHYsIGkpID0+IHtcbiAgICBpZiAoaSA+IDIwICYmIGkgPCAyMSAqIDUgJiYgaSAlIDMgPCAyKSB7XG4gICAgICBjb25zdCByb3cgPSBNYXRoLmZsb29yKGkgLyAzKTtcbiAgICAgIGNvbnN0IGNvbCA9IGkgJSAzO1xuICAgICAgcmV0dXJuIHByaW1pdGl2ZXNbcm93ICUgN11bY29sXTtcbiAgICB9XG4gICAgcmV0dXJuIHY7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBvZmZzZXQoW3B4LCBweV0sIFt4MCwgeTBdKSB7XG4gIHJldHVybiBbW3B4IC0geDBdLCBbcHkgLSB5MF1dO1xufVxuXG5mdW5jdGlvbiByb3RhdGUoW2N4LCBjeV0sIFt4LCB5XSwgcmFkaWFucykge1xuICBjb25zdCBjb3MgPSBNYXRoLmNvcyhyYWRpYW5zKTtcbiAgY29uc3Qgc2luID0gTWF0aC5zaW4ocmFkaWFucyk7XG4gIGNvbnN0IG54ID0gKGNvcyAqICh4IC0gY3gpKSArIChzaW4gKiAoeSAtIGN5KSkgKyBjeDtcbiAgY29uc3QgbnkgPSAoY29zICogKHkgLSBjeSkpIC0gKHNpbiAqICh4IC0gY3gpKSArIGN5O1xuXG4gIHJldHVybiBbbngsIG55XTtcbn1cblxuZnVuY3Rpb24gZ2V0RGlzdGFuY2UocHQwLCBwdDEpIHtcbiAgY29uc3QgZHggPSBwdDBbMF0gLSBwdDFbMF07XG4gIGNvbnN0IGR5ID0gcHQwWzFdIC0gcHQxWzFdO1xuICBjb25zdCBkeHkgPSBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpO1xuICByZXR1cm4gZHh5O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmFkaXVzKHB0MCwgcHQzKSB7XG4gIGNvbnN0IGR4eSA9IGdldERpc3RhbmNlKHB0MCwgcHQzKTtcbiAgcmV0dXJuIGR4eSAvIDI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBbmdsZShwdDAsIHB0Mykge1xuICBjb25zdCBkeCA9IHB0MFswXSAtIHB0M1swXTtcbiAgY29uc3QgZHkgPSBwdDBbMV0gLSBwdDNbMV07XG4gIGNvbnN0IGR4eSA9IE1hdGguc3FydChkeCAqIGR4ICsgZHkgKiBkeSk7XG5cbiAgLy8gQ2FsY3VsYXRlIGFuZ2xlIHRoYXQgdGhlIHBlcnBlbmRpY3VsYXIgaGV4YWdvbiB2ZXJ0ZXggYXhpcyBpcyB0aWx0ZWRcbiAgY29uc3QgYW5nbGUgPSBNYXRoLmFjb3MoZHggLyBkeHkpICogTWF0aC5zaWduKGR5KTtcbiAgcmV0dXJuIGFuZ2xlO1xufVxuXG5mdW5jdGlvbiBnZXRQdE9uQ2lyY2xlKHJhZGl1cywgYW5nbGUpIHtcbiAgcmV0dXJuIFtyYWRpdXMgKiAgTWF0aC5jb3MoYW5nbGUpLCByYWRpdXMgKiAgTWF0aC5zaW4oYW5nbGUpXTtcbn1cblxuZnVuY3Rpb24gZ2V0SGV4YWdvblZlcnRpY2VzKHIpIHtcbiAgY29uc3QgYW5nNjAgPSBNYXRoLlBJIC8gMztcbiAgY29uc3QgcHRzID0gW11cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHtcbiAgICBwdHMucHVzaChnZXRQdE9uQ2lyY2xlKHIsIGFuZzYwICogaSkpXG4gIH1cblxuICByZXR1cm4gcHRzO1xufVxuXG5mdW5jdGlvbiByZXZlcnRWZXJ0aWNlcyh2ZXJ0cykge1xuICAvLyByZXZlcnRpbmcgdmVydHMgZnJvbSBjbG9jayAoaDMpIHRvIGNvdW50ZXIgY2xvY2sgd2lzZSAobHVtYSBjeWxpbmRlcilcbiAgY29uc3Qgc2VxID0gWzAsIDUsIDQsIDMsIDIsIDFdO1xuICByZXR1cm4gc2VxLm1hcChzID0+IHZlcnRzW3NdKTtcbn1cblxuZnVuY3Rpb24gZ2V0VHJhbnNsYXRpb25zKHZ0cywgb3JpZ3MpIHtcbiAgLy8gMCBhbmQgMyBzaG91bGQgYmUgdGhlIGd1aWRlXG4gIGNvbnN0IGN0ID0gWzAsIDBdO1xuICBjb25zdCB0cmFuc2xhdGlvbnMgPSBbXTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykge1xuICAgIGNvbnN0IHZ0ID0gdnRzW2ldO1xuICAgIGNvbnN0IG9yZyA9IG9yaWdzW2ldO1xuXG4gICAgY29uc3QgciA9IGdldFJhZGl1cyhvcmcsIGN0KTtcbiAgICBjb25zdCBkciA9IGdldFJhZGl1cyh2dCwgY3QpIC8gclxuXG4gICAgY29uc3QgZGEgPSBNYXRoLmF0YW4yKHZ0WzFdLCB2dFswXSkgLSBNYXRoLmF0YW4yKG9yZ1sxXSwgb3JnWzBdKTtcblxuICAgIHRyYW5zbGF0aW9ucy5wdXNoKHtkciwgZGF9KTtcbiAgfVxuXG4gIHJldHVybiB0cmFuc2xhdGlvbnM7XG59XG4iXX0=